#!groovy

node {
  agent 'macOS' //check if this build machine has Python3.7
  environment{
    registry = "????"
  }
  try {
      stage('Checkout'){
        checkout scm

        sh 'git log HEAD^..HEAD --pretty="%h %an - %s" > GIT_CHANGES'
        def lastChanges = readFile('GIT_CHANGES')
      }

      stage('Test'){
        sh 'virtualenv env -p python3.7'
        sh '. env/bin/activate'
        sh 'pip install -r requirements.txt'
        sh 'python3 manage.py test'
        sh 'env/bin/deactivate'
      }

      stage('Build'){
        steps{
          script{
            myapp = docker.build("CMU-DB/performance-storage-service:${env.BUILD_ID}")
          }
        }
      }

      stage('Publish'){
        environment {
            registryCredential = '????'
        }
        steps{
            script {
              docker.withRegistry('https://registry.hub.docker.com', 'dockerhub') {
                myapp.push("latest")
                myapp.push("${env.BUILD_ID}")
              }
            }
        }
      }

      stage ('Deploy'){
        steps{
          script{
            def image_id = registry + ":$BUILD_NUMBER"
            sh "ansible-playbook  deployment/deployment-test.yml"
          }
        }
      }
  }

  catch (err) {

      throw err
  }

}
