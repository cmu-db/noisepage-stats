#!groovy

def dockerImage = ''

pipeline {
  environment {
    //TODO: maybe read this from file
    REGISTRY = "cmudb/performance-storage-service"
    REGISTRY_CREDENTIAL = 'cmudb-dockerhub'
    VERSION = "0.1.0"
  }
  agent {
    label 'docker'
  }
  stages{
    stage('Checkout'){
      steps{
        checkout scm
      }
    }

    stage('Build'){
      steps{
        dir('performance-storage-service'){
          script{
            dockerImage = docker.build REGISTRY + ":${VERSION}"
          }
        }
      }
    }

    stage('Test'){
      steps{
        dir('performance-storage-service'){
          docker.image('timescaledb:latest-pg12').withRun('-e "POSTGRES_PASSWORD=password" -p 5432:5432') { c ->
            /* Wait until timescale service is up */
            sh 'while ! mysqladmin ping -h0.0.0.0 --silent; do sleep 1; done'
            sh 'until psql -h $PG_HOST -U $PG_USER -d $PG_DATABASE -c "select 1" > /dev/null 2>&1; do
              echo "Waiting for postgres server"
              sleep 1
            done'
          }
          sh "docker run -e SECRET_KEY=shhh --entrypoint python ${REGISTRY}:${VERSION} manage.py jenkins --enable-coverage"
        }
      }
    }

    stage('Publish'){
      when{
        branch 'test'
      }
      steps{
        script{
          dir('performance-storage-service'){
            docker.withRegistry('', REGISTRY_CREDENTIAL) {
                dockerImage.push("latest")
                dockerImage.push("${VERSION}")
            }
          }
        }
      }
    }
  }

  post {
    cleanup{
      script{
        if (env.BRANCH_NAME == 'test') {
          echo "removing docker image"
          sh "docker rmi ${REGISTRY}:${VERSION}"
        }
        echo "deleting directory"
        deleteDir()
      }
    }
  }
}
