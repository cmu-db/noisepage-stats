#!groovy

def dockerImage = ''
def tsImage = ''

pipeline {
  environment {
    REGISTRY = "cmudb/performance-storage-service"
    REGISTRY_CREDENTIAL = 'cmudb-dockerhub'
    VERSION = "1.0.0"
    TIMESCALE_IMAGE = 'timescale/timescaledb:latest-pg12'
  }
  agent {
    label 'docker'
  }
  stages{
    stage('Checkout'){
      steps{
        checkout scm
      }
    }

    stage('Build'){
      steps{
        dir('performance-storage-service'){
          script{
            dockerImage = docker.build REGISTRY + ":${VERSION}"
          }
        }
      }
    }

    stage('Test'){
      steps{
        script{
          dir('performance-storage-service'){
            docker.withRegistry('', REGISTRY_CREDENTIAL) {
              sh "docker ps"
              sh "docker stop ${TIMESCALE_IMAGE}"
              docker.image(TIMESCALE_IMAGE).withRun('-e "POSTGRES_PASSWORD=password" -p 5432:5432') { c ->
                /* Wait until timescale service is up */
                tsImage = c
                sh """
                  apt-get install postgresql-client-9.6
                  until pg_isready -d postgres -h 127.0.0.1 -p 5432 -U postgres > 1; do
                  echo "Waiting for postgres server"
                  sleep 1
                done"""
              }
            }
            sh "docker run -e SECRET_KEY=shhh --entrypoint python ${REGISTRY}:${VERSION} manage.py jenkins --enable-coverage"
          }
        }
      }
    }

    stage('Publish'){
      when{
        branch 'test'
      }
      steps{
        script{
          dir('performance-storage-service'){
            docker.withRegistry('', REGISTRY_CREDENTIAL) {
                dockerImage.push("latest")
                dockerImage.push("${VERSION}")
            }
          }
        }
      }
    }
  }

  post {
    cleanup{
      script{
        if (env.BRANCH_NAME == 'test') {
          echo "removing docker image"
          sh "docker rmi ${REGISTRY}:${VERSION}"
        }
        tsImage.stop
        sh "docker rmi ${TIMESCALE_IMAGE} -f"
        echo "deleting directory"
        deleteDir()
      }
    }
  }
}
